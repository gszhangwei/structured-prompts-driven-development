# API详细故事生成模板和标准

基于团队管理API详细故事拆分的成功实践，总结出以下结构化的故事生成模板，用于生成高质量、一致性的API开发故事。

## 🎯 生成目标和原则

### 核心目标
- **完整性**: 每个story都是独立、可实施的完整功能
- **一致性**: 统一的结构格式、命名规范和质量标准
- **实用性**: 包含具体的技术实现指导和最佳实践
- **安全性**: 全面的安全考虑和防护措施
- **可测性**: 明确的验收标准和测试指导

### 基本原则
- **单一职责**: 每个story专注于一个特定的API操作
- **集成验证**: 所有验证规则直接集成到对应的CRUD操作中
- **最佳实践**: 融合行业标准的安全、性能、监控最佳实践
- **渐进复杂度**: 从简单到复杂的功能实现顺序

### INVEST原则指导

#### 🔍 任务分析和Story拆分策略

在创建任何story之前，必须先进行**INVEST原则分析**：

**INVEST原则检查清单**:
- **I**ndependent (独立性): story可以独立开发、测试和部署
- **N**egotiable (可协商): 需求细节可以与开发团队讨论调整
- **V**aluable (有价值): 为最终用户或业务带来明确价值
- **E**stimable (可估算): 开发团队可以合理估算工作量
- **S**mall (合适大小): 可以在1-2个sprint内完成
- **T**estable (可测试): 有明确的验收标准和测试方法

#### 📋 抽象任务分析流程

**步骤1: 识别抽象任务**
```markdown
对于复杂功能，首先分析抽象任务层次：

### 抽象任务示例: "团队管理功能"

**分析维度**:
- **核心职责**: 团队数据的生命周期管理
- **主要操作**: 创建、查询、更新、删除、列表
- **关键约束**: 数据唯一性、权限控制、关联关系
- **技术复杂度**: 中等（标准CRUD + 业务规则）
- **业务复杂度**: 中等（多种查询场景 + 删除级联）
```

**步骤2: INVEST合规性检查**
```markdown
### INVEST评估:
- ✅ **Independent**: 团队管理独立于项目和记忆功能
- ✅ **Negotiable**: 具体API设计细节可协商
- ✅ **Valuable**: 为组织管理提供基础能力
- ❌ **Estimable**: 过于复杂，难以准确估算
- ❌ **Small**: 包含5个API，工作量过大
- ✅ **Testable**: 每个API都有明确验收标准

**结论**: 需要拆分，不符合Small原则
```

**步骤3: 故事拆分策略**
```markdown
### 拆分策略: 按操作类型拆分 (推荐)

**原则**: 每个story包含2-3个相关的核心功能点

**拆分结果**:
1. **[STORY-003-001] 团队创建和基础查询API** 
   - ✅ 包含: POST /teams + GET /teams/{id}
   - ✅ 理由: 创建后需要立即验证，逻辑相关
   - ✅ 估算: 3-4天，符合Small原则

2. **[STORY-003-002] 团队列表查询和搜索API**
   - ✅ 包含: GET /teams + 搜索过滤
   - ✅ 理由: 列表和搜索都是查询类操作
   - ✅ 估算: 2-3天，符合Small原则

3. **[STORY-003-003] 团队更新和删除API**
   - ✅ 包含: PUT /teams/{id} + DELETE /teams/{id}
   - ✅ 理由: 都涉及现有数据修改和复杂业务规则
   - ✅ 估算: 3-4天，符合Small原则
```

#### 🎯 Story拆分最佳实践

**拆分规则**:
1. **每个story最多包含2-3个核心功能点**
2. **功能点之间必须有逻辑相关性**
3. **单个story工作量控制在1-5天**
4. **确保每个story都能产生独立的业务价值**

**拆分维度选择**:
- **按操作类型**: CREATE-READ / UPDATE-DELETE / LIST-SEARCH
- **按复杂度**: 基础功能 / 高级功能 / 管理功能  
- **按用户角色**: 普通用户功能 / 管理员功能
- **按技术依赖**: 核心功能 / 扩展功能

---

## 📋 标准故事结构模板

请按照以下结构生成每个API story：

### 故事标题格式
```
## [STORY-{模块编号}-{序号}] {操作描述}API开发

示例: ## [STORY-003-001] 团队创建API开发
```

### 必需章节结构

#### 1. Background (背景说明)
```markdown
### Background
[描述该API的业务背景、使用场景和在整体系统中的作用]

要点：
- 业务价值和用户需求
- 与其他功能的关联关系
- 技术实现的必要性
```

#### 2. Business Value (业务价值)
```markdown
### Business Value
[列出该API带来的具体业务价值，用bullet points]

格式：
- 为{角色}提供{具体能力}
- 支持{业务场景}的{具体需求}
- 实现{系统目标}的{关键功能}
```

#### 3. Technical Context (技术上下文)
```markdown
### Technical Context
基于{实体名称}的{操作类型}，需要考虑：

必须包含：
- 数据模型定义（SQL结构）
- 技术实现要点
- 性能考虑因素
- 相关的数据库索引和约束
```

#### 4. Scope In/Out (范围定义)
```markdown
### Scope In
[本story包含的功能范围，用bullet points]

### Scope Out  
[本story不包含的功能范围，用bullet points]
```

#### 5. ACs (Acceptance Criteria) 
```markdown
### ACs (Acceptance Criteria)

#### AC1: 基础{操作}功能
**Given** {前置条件}
**When** {操作行为}
**Then** {预期结果}

**验收细节**:
[具体的功能要求和性能指标]

#### AC2: 数据验证和业务规则
[数据格式验证规则]
[业务规则检查逻辑]

#### AC3: 安全策略和输入清洗  
[安全防护措施]
[输入验证和清洗规则]

#### AC4: 权限控制和数据过滤
[权限级别定义]
[数据访问控制规则]

#### AC5: 错误处理和响应标准化
[错误场景分类]
[标准化错误响应格式]

#### AC6: 审计日志和性能监控
[审计日志记录要求]
[性能监控指标定义]
```

---

## 🔧 内容生成标准

### 数据验证规则标准

#### 字段验证格式
```markdown
**数据格式验证**:
- {字段名}字段：{必需性}，{长度限制}，{格式要求}，{特殊规则}
- 示例: name字段：必需，2-50字符，仅字母数字下划线连字符，不区分大小写唯一
```

#### 业务规则格式
```markdown
**业务规则检查**:
- {规则描述}：{具体实现要求}
- 示例: 团队名称全局唯一性验证
```

### 安全防护标准

#### 必须包含的安全检查
```markdown
**安全检查实施**:
- SQL注入防护：使用参数化查询，验证输入字符集
- XSS攻击防护：HTML内容清洗，移除script、iframe等危险标签
- 输入长度限制：防止恶意的超长输入攻击
- 敏感信息保护：API密钥、token等自动脱敏
- {其他特定安全措施}
```

### 权限控制标准

#### 权限级别格式
```markdown
**权限控制规则**:
- {角色1}：{权限范围描述}
- {角色2}：{权限范围描述}
- {角色3}：{权限范围描述}
- 非{实体}成员：返回403禁止访问

示例:
- 团队Owner：可更新所有字段包括敏感配置
- 团队管理员：可更新基础信息（name, description）
- 团队成员：仅可更新description字段
```

### 错误处理标准

#### 错误分类格式
```markdown
**错误场景分类**:
- 400 Bad Request: 数据格式错误、验证失败
- 403 Forbidden: 权限不足、操作被拒绝
- 404 Not Found: 资源不存在或已被删除
- 409 Conflict: 唯一性冲突、并发更新冲突
- 429 Too Many Requests: 频率限制
- 500 Internal Server Error: 系统错误
```

#### 标准错误响应格式
```json
{
  "error": "ERROR_CODE",
  "message": "用户友好的错误描述",
  "details": {
    "field": "具体字段名",
    "value": "导致错误的值",
    "suggestion": "建议的解决方案"
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "request_id": "req_123456"
}
```

### 性能监控标准

#### 必须包含的性能指标
```markdown
**性能监控指标**:
- 响应时间分布：P50, P95, P99响应时间
- {操作类型}执行时间：{具体操作}耗时分析
- 数据库操作性能：{SQL操作}时间、索引使用情况
- 错误率统计：{具体错误类型}率统计
- {其他特定性能指标}
```

#### 性能要求格式
```markdown
- 响应时间：P99 < {时间}ms，P95 < {时间}ms
- 缓存命中率≥{百分比}%
- {特定操作}成功率≥{百分比}%
```

---

## 📊 按CRUD操作类型的特定要求

### CREATE操作特定要求
```markdown
必须包含：
- 唯一性约束检查和冲突处理
- 默认值设置和初始化逻辑
- 创建时间戳自动设置
- 响应数据安全过滤（排除敏感字段）
- 创建后的关联数据初始化
```

### READ操作特定要求
```markdown
必须包含：
- 存在性验证和权限检查
- 基于权限的数据过滤
- 缓存策略和性能优化
- 统计数据的计算和包含
- 敏感信息脱敏处理
```

### UPDATE操作特定要求
```markdown
必须包含：
- 并发控制和版本检查
- 部分更新支持
- 唯一性检查（排除自身）
- 变更追踪和审计日志
- 缓存失效和同步更新
```

### DELETE操作特定要求
```markdown
必须包含：
- 删除前置条件检查
- 关联数据级联处理策略
- 软删除vs硬删除决策
- 删除确认机制
- 事务完整性和回滚处理
```

### LIST操作特定要求
```markdown
必须包含：
- 分页参数验证和处理
- 排序功能和字段白名单
- 过滤查询和搜索安全
- 批量数据的性能优化
- 元数据响应（总数、分页信息等）
```

---

## 🎪 质量检查清单

在生成每个story后，确保包含以下要素：

### ✅ 结构完整性
- [ ] 包含所有必需章节（Background, Business Value, Technical Context, Scope, ACs）
- [ ] 每个AC都有明确的Given-When-Then结构
- [ ] 验收细节具体且可测试
- [ ] 错误响应包含标准JSON格式示例

### ✅ 安全性覆盖
- [ ] SQL注入防护措施
- [ ] XSS攻击防护措施
- [ ] 输入验证和清洗规则
- [ ] 权限控制和访问限制
- [ ] 敏感信息保护和脱敏

### ✅ 性能考虑
- [ ] 明确的响应时间要求（P95, P99）
- [ ] 缓存策略和优化方案
- [ ] 数据库查询和索引利用
- [ ] 并发控制和资源管理

### ✅ 监控审计
- [ ] 完整的审计日志要求
- [ ] 性能监控指标定义
- [ ] 错误统计和分析需求
- [ ] 业务指标收集要求

### ✅ 实施指导
- [ ] 具体的技术实现提示
- [ ] 数据库结构和约束要求
- [ ] 集成测试场景说明
- [ ] 错误场景覆盖全面

---

## 🚀 使用说明

### 生成新story时的步骤

#### 阶段1: INVEST原则分析

1. **抽象任务识别**
   - 明确功能的核心职责和业务价值
   - 分析主要操作和技术复杂度
   - 识别关键约束和依赖关系

2. **INVEST合规性评估**
   - 逐项检查INVEST六个维度
   - 识别不符合项（特别关注Small和Estimable）
   - 记录评估结论和拆分需求

3. **拆分策略制定**
   - 选择合适的拆分维度（操作类型/复杂度/用户角色）
   - 确保每个子story包含2-3个相关功能点
   - 验证拆分后的story符合INVEST原则

#### 阶段2: Story内容生成

4. **确定基础信息**
   - 模块编号和故事序号
   - API操作类型（GET/POST/PUT/DELETE）
   - 核心实体和数据模型

5. **填充模板结构**
   - 按照标准章节结构组织内容
   - 确保每个AC都包含完整的验证、安全、性能要求
   - 根据CRUD类型添加特定要求

6. **质量检查**
   - 对照质量检查清单验证完整性
   - 确保技术细节具体可实施
   - 验证安全和性能要求覆盖全面

7. **一致性校准**
   - 检查命名规范和术语使用
   - 确保错误响应格式统一
   - 验证监控指标定义一致

#### 阶段3: INVEST再次验证

8. **最终INVEST检查**
   - 确认每个生成的story都完全符合INVEST原则
   - 验证story间的独立性和依赖关系
   - 确保整体拆分策略的合理性

### INVEST原则实施指导

#### 常见拆分场景和策略

**场景1: 复杂CRUD功能**
```markdown
抽象任务: "用户管理功能" (包含注册、登录、权限、资料等)

INVEST分析:
❌ Small: 功能过于复杂，包含4-5个独立子系统
❌ Estimable: 涉及多个技术领域，难以准确估算

拆分策略:
1. [STORY-XXX-001] 用户注册和基础资料管理 (2-3天)
2. [STORY-XXX-002] 用户认证和会话管理 (3-4天)  
3. [STORY-XXX-003] 用户权限和角色管理 (3-4天)
```

**场景2: 单一操作但技术复杂**
```markdown
抽象任务: "AI模型训练API" (单个API但实现复杂)

INVEST分析:
❌ Small: 单个功能但工作量超过1周
❌ Estimable: 涉及AI算法，技术不确定性高

拆分策略:
1. [STORY-XXX-001] 训练数据准备和验证API (2天)
2. [STORY-XXX-002] 模型训练任务提交和管理API (3-4天)
3. [STORY-XXX-003] 训练进度监控和结果查询API (2天)
```

**场景3: 多个简单操作**
```markdown
抽象任务: "标签管理功能" (5个简单CRUD操作)

INVEST分析:
✅ 每个操作都简单且独立
❌ Small: 总工作量仍然过大

拆分策略:
1. [STORY-XXX-001] 标签创建和查询API (2天)
2. [STORY-XXX-002] 标签更新删除和列表API (2天)
3. [STORY-XXX-003] 标签统计和关联分析API (2天)
```

### 拆分质量验证清单

**✅ 每个拆分后的story必须满足**:
- [ ] **独立性**: 不依赖其他story的实现细节
- [ ] **完整性**: 包含完整的功能闭环和验收标准
- [ ] **价值性**: 单独实现后能产生业务价值
- [ ] **可估算**: 技术团队能准确估算开发时间
- [ ] **合适大小**: 1-5天工作量，最多3个核心功能点
- [ ] **可测试**: 有明确的测试场景和验收条件

**⚠️ 避免的拆分错误**:
- ❌ **技术分层拆分**: 不要按前端/后端/数据库层拆分同一功能
- ❌ **过度细化**: 不要将单个API拆成多个story
- ❌ **逻辑割裂**: 不要破坏业务逻辑的完整性
- ❌ **依赖复杂**: 避免创建复杂的story间依赖关系

### 自定义适配指导

对于不同的业务领域和技术栈，可以在以下方面进行适配：

- **实体模型**：根据具体的数据模型调整字段验证规则
- **业务规则**：根据业务逻辑添加特定的验证和检查
- **技术栈**：根据技术选型调整安全防护和性能优化措施
- **监管要求**：根据合规需求调整审计和日志记录要求

---

## 📖 示例参考

### 成功拆分示例
完整的参考示例请查看：`team-management-api-detailed-stories.md`

该文件展示了如何将"团队管理"这个大功能按照INVEST原则拆分为5个独立story：
1. **STORY-003-001**: 团队创建API (核心功能)
2. **STORY-003-002**: 团队查询API (基础查询) 
3. **STORY-003-003**: 团队列表API (复杂查询)
4. **STORY-003-004**: 团队更新API (复杂业务规则)
5. **STORY-003-005**: 团队删除API (级联处理)

每个story都符合INVEST原则，工作量控制在2-4天，具有独立的业务价值。